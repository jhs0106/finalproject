<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mun'cok CCTV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body { background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; font-family: sans-serif; }
        video { width: 100%; max-width: 640px; border-radius: 10px; border: 2px solid #333; }
        .info { margin-top: 10px; text-align: center; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; background: #333; }
        .badge.on { background: #28a745; color: white; }
        .badge.processing { background: #ffc107; color: #000; }
    </style>
</head>
<body>
<h2 id="title">CCTV ì´ˆê¸°í™” ì¤‘...</h2>
<video id="preview" autoplay playsinline muted></video>
<div class="info">
    <span id="status" class="badge">ì—°ê²° ëŒ€ê¸°</span>
    <span id="ai-status" class="badge">AI ì¤€ë¹„</span>
    <p id="log" style="font-size: 0.8rem; color: #aaa;">...</p>
</div>

<script th:inline="javascript">
    const ADMIN_HOST = "10.20.36.180";
    const SIGNALING_URL = `wss://${ADMIN_HOST}:8444/signal`;
    const ANALYSIS_ENDPOINT = `https://${ADMIN_HOST}:8444/cctv/api/analysis`;
    const ANALYSIS_INTERVAL = 30000;

    // ID ìƒì„±
    let serverId = [[${cctvId}]];
    if (!serverId) serverId = "";
    const urlParams = new URLSearchParams(window.location.search);
    const CCTV_ID = serverId || urlParams.get('id') || 'cctv-' + Math.floor(Math.random() * 1000);

    document.getElementById('title').textContent = `ğŸ“· CCTV: ${CCTV_ID}`;
    document.title = `CCTV - ${CCTV_ID}`;

    const videoEl = document.getElementById('preview');
    const statusEl = document.getElementById('status');
    const aiStatusEl = document.getElementById('ai-status');
    const logEl = document.getElementById('log');

    let socket;
    let peerConnection;
    let localStream;

    function log(msg) { logEl.textContent = msg; console.log(msg); }

    async function startCamera() {
        try {
            // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
            const constraints = {
                video: { facingMode: { ideal: "environment" } },
                audio: false
            };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            videoEl.srcObject = localStream;
            log("ì¹´ë©”ë¼ ì‘ë™. ì„œë²„ ì—°ê²° ì‹œë„...");
            connectSocket();
            setInterval(runAnalysis, ANALYSIS_INTERVAL);
        } catch (e) {
            log("ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜: " + e.message);
        }
    }

    function connectSocket() {
        socket = new WebSocket(SIGNALING_URL);

        socket.onopen = () => {
            statusEl.className = "badge on";
            statusEl.textContent = "ì„œë²„ ì—°ê²°ë¨";
            log("ëŒ€ê¸° ì¤‘...");
        };

        socket.onclose = () => {
            statusEl.className = "badge";
            statusEl.textContent = "ì—°ê²° ëŠê¹€";
            setTimeout(connectSocket, 3000);
        };

        socket.onmessage = async (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'viewer_joined') {
                const delay = Math.floor(Math.random() * 3000);
                log(`ê´€ë¦¬ì ì ‘ì†! ${delay}ms í›„ ì—°ê²°`);
                setTimeout(async () => {
                    createPeerConnection();
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    send({ type: 'offer', id: CCTV_ID, sdp: offer.sdp });
                }, delay);
            } else if (msg.type === 'answer' && msg.id === CCTV_ID) {
                if (peerConnection) await peerConnection.setRemoteDescription(new RTCSessionDescription(msg));
            } else if (msg.type === 'candidate' && msg.id === CCTV_ID) {
                if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(msg.candidate));
            }
        };
    }

    function send(data) {
        if(socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify(data));
    }

    function createPeerConnection() {
        if (peerConnection) peerConnection.close();
        peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        peerConnection.onicecandidate = (e) => {
            if (e.candidate) send({ type: 'candidate', id: CCTV_ID, candidate: e.candidate });
        };
    }

    // [í•µì‹¬ ìˆ˜ì •] AI ë¶„ì„ ë¡œì§ ê°•í™”
    async function runAnalysis() {
        if (!videoEl.videoWidth) return;

        aiStatusEl.className = "badge processing";
        aiStatusEl.textContent = "ë¶„ì„ ì¤‘...";

        const canvas = document.createElement('canvas');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        canvas.getContext('2d').drawImage(videoEl, 0, 0);

        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            // [ìˆ˜ì •] ì§ˆë¬¸ì„ êµ¬ì²´ì ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ AIê°€ ìƒì„¸ ìƒí™©ì„ ì„¤ëª…í•˜ë„ë¡ ìœ ë„
            const prompt = "í™”ë©´ì„ ë¶„ì„í•´ì¤˜. í™”ì¬, ì—°ê¸°, ì‚¬ëŒì´ ì“°ëŸ¬ì§, í™ìˆ˜, íƒœí’, ì¹¨ìˆ˜, êµí†µì‚¬ê³ , ì¹¼ë¶€ë¦¼ ë“± ìœ„í—˜í•œ ì¬ë‚œì´ë‚˜ ì‚¬ê³  ìƒí™©ì´ ë³´ì´ë©´ êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ìƒí™©ì¸ì§€ í•œ ë¬¸ì¥ìœ¼ë¡œ ë¬˜ì‚¬í•˜ê³  ë¬¸ì¥ ëì— ë°˜ë“œì‹œ 'alert' ë‹¨ì–´ë¥¼ ë¶™ì—¬ì¤˜. (ì˜ˆ: ì‚¬ëŒì´ ë°”ë‹¥ì— ì“°ëŸ¬ì ¸ ìˆìŠµë‹ˆë‹¤ alert). ìœ„í—˜í•˜ì§€ ì•Šìœ¼ë©´ 'normal'ì´ë¼ê³ ë§Œ ë‹µí•´.";

            formData.append('question', prompt);
            formData.append('attach', blob, 'frame.png');

            try {
                const res = await fetch(ANALYSIS_ENDPOINT, { method: 'POST', body: formData });
                const text = await res.text();

                let severity = 'normal';
                let message = 'ì´ìƒ ì—†ìŒ';

                // [ìˆ˜ì •] ì‘ë‹µ í…ìŠ¤íŠ¸ íŒŒì‹± ë¡œì§ ê°œì„ 
                if (text.toLowerCase().includes('alert') || text.includes('ìœ„í—˜') || text.includes('í™”ì¬')) {
                    severity = 'alert';
                    // 'alert' ë‹¨ì–´ëŠ” ì œê±°í•˜ê³  ì„¤ëª…ë§Œ ë‚¨ê¹€
                    message = text.replace(/alert/gi, '').trim();
                    if(message.length === 0) message = "ìœ„í—˜ ìƒí™© ê°ì§€ë¨ (ìƒì„¸ ë‚´ìš© ì—†ìŒ)";

                    // í™”ì¬ì¼ ê²½ìš° 119 ë©˜íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)
                    if(message.includes('í™”ì¬') || message.includes('ë¶ˆ')) {
                        message += " (119 ìë™ ì‹ ê³  ì™„ë£Œ)";
                    }
                }

                send({
                    type: 'CCTV_ANALYSIS_RESULT',
                    payload: {
                        cctvId: CCTV_ID,
                        severity: severity,
                        message: message,
                        timestamp: new Date().toISOString()
                    }
                });

                aiStatusEl.className = "badge on";
                aiStatusEl.textContent = "ë¶„ì„ ì™„ë£Œ";

            } catch(e) {
                console.error(e);
                aiStatusEl.className = "badge";
                aiStatusEl.textContent = "ë¶„ì„ ì‹¤íŒ¨";
            }
        });
    }

    startCamera();
</script>
</body>
</html>